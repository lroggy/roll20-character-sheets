<script type="text/worker">

    function rollDice() {
        return 1 + Math.floor(Math.random() * 6);
    }

    on('clicked:roll', () => {
        startRoll("!{{query=1}} {{Opposition=[[?{Niveau d'opposition|5}]]}} {{BonusDescripteur=[[?{Bonus de descripteur ?|Non (1),1|Oui (3),3}]]}} {{Soma=[[?{Soma utilisé|0}]]}} {{Dice=[[?{Dés lancés|0}]]}}", (results) => {
            // Récupérer les valeurs saisies par l'utilisateur
            const opposition = results.results.Opposition.result;
            const descripteur = results.results.BonusDescripteur.result;
            const soma = results.results.Soma.result;
            const dice = results.results.Dice.result;

            // Lancer les dés via Roll20
            startRoll(`&{template:default} {{name=Jet de Chasseur}} {{Opposition=${opposition}}} {{Bonus Descripteur=${descripteur}}} {{Soma=${soma}}} {{Dés=[[${dice}d6>2]]}}`, (diceResults) => {
                const diceRoll = diceResults.results.Dés.result;
                const total = (diceRoll + soma + descripteur) + ' sur ' + opposition;

                let resultat = '';

                if(diceRoll < dice) {
                    resultat = '❌ **Échec** - Au moins un dé est tombé sur 1';
                } else if(total < opposition) {
                    resultat = '❌ **Échec**';
                } else if(total === opposition) {
                    resultat = '✓ **Dénouement avec Coût (Oui mais ...)**';
                } else if(total === opposition + 1) {
                    resultat = '✓ **Dénouement standard (Oui ...)**';
                } else {
                    resultat = '✓ **Dénouement avec Avantage (Oui et ...)**';
                }

                // Afficher le résultat dans le chat
                startRoll(`&{template:default} {{name=Résultat}} {{Total=${total}}} {{Résultat=${resultat}}}`, (finalResults) => {
                    finishRoll(finalResults.rollId);
                });

                // Réduire les points de Soma
                if (soma > 0) {
                    getAttrs(['soma'], function(values) {
                        const currentSoma = parseInt(values.soma) || 0;
                        const newSoma = currentSoma - soma;
                        setAttrs({
                            soma: newSoma
                        });
                    });
                }

                finishRoll(diceResults.rollId);
            });

            finishRoll(results.rollId);
        });
    });
</script>


<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="brokenTales.css">
</head>

<body>
    <!-- Broken Tales — Fiche de Chasseur (Roll20) -->
    <div class="sheet-page">

        <!-- ENTÊTE -->
        <header class="sheet-header">
            <div class="sheet-header-left">
                <div class="sheet-block">
                    <div class="sheet-label">Fiche de Chasseur</div>
                    <label class="sheet-inline">
                        Joueur :
                        <input type="text" name="attr_joueur" class="sheet-line" />
                    </label>
                    <label class="sheet-inline">
                        Chasseur :
                        <input type="text" name="attr_chasseur" class="sheet-line" />
                    </label>
                </div>
            </div>

            <div class="sheet-header-right">
                <div class="sheet-title-logo">Broken<br>Tales</div>
                <div class="sheet-block">
                    <div class="sheet-label">Description :</div>
                    <textarea name="attr_description" class="sheet-ruled" rows="4"></textarea>
                </div>
            </div>
        </header>

        <!-- SEPARATEUR -->
        <div class="sheet-divider">
            <span>Descripteurs et Dons</span>
        </div>

        <!-- CORPS EN 2 COLONNES -->
        <section class="sheet-two-cols">
            <!-- Colonne gauche -->
            <div class="sheet-col">
                <!-- Descripteur 1 -->
                <div class="sheet-descriptor">
                    <label class="sheet-circle-check">
                        <input type="checkbox" name="attr_descr1_check">
                        <span></span>
                    </label>
                    <div class="sheet-descriptor-body">
                        <label class="sheet-label-sm sheet-label-lg">Descripteur :</label>
                        <textarea name="attr_descr1" class="sheet-ruled sheet-ruled-small"></textarea>
                    </div>
                </div>
                <div class="sheet-descriptor-body">
                    <label class="sheet-label-sm sheet-label-lg mt6">Don :</label>
                    <textarea name="attr_don1" class="sheet-ruled sheet-ruled-medium"></textarea>
                </div>

                <!-- Descripteur 2 -->
                <div class="sheet-descriptor mt16">
                    <label class="sheet-circle-check">
                        <input type="checkbox" name="attr_descr2_check">
                        <span></span>
                    </label>
                    <div class="sheet-descriptor-body">
                        <label class="sheet-label-sm sheet-label-lg">Descripteur :</label>
                        <textarea name="attr_descr2" class="sheet-ruled sheet-ruled-small"></textarea>
                    </div>
                </div>
                <div class="sheet-descriptor-body">
                    <label class="sheet-label-sm sheet-label-lg mt6">Don :</label>
                    <textarea name="attr_don2" class="sheet-ruled sheet-ruled-medium"></textarea>
                </div>

                <!-- EQUIPEMENT -->
                <div class="sheet-divider small mt20"><span>Équipement</span></div>
                <textarea name="attr_equipement" class="sheet-ruled" rows="8"></textarea>
            </div>

            <!-- Colonne droite -->
            <div class="sheet-col">
                <!-- Descripteur 3 -->
                <div class="sheet-descriptor">
                    <label class="sheet-circle-check">
                        <input type="checkbox" name="attr_descr3_check">
                        <span></span>
                    </label>
                    <div class="sheet-descriptor-body">
                        <label class="sheet-label-sm sheet-label-lg">Descripteur :</label>
                        <textarea name="attr_descr3" class="sheet-ruled sheet-ruled-small"></textarea>
                    </div>
                </div>
                <div class="sheet-descriptor-body">
                    <label class="sheet-label-sm sheet-label-lg mt6">Sombre Ego :</label>
                    <textarea name="attr_sombreEgo" class="sheet-ruled sheet-ruled-medium"></textarea>


                    <div class="ml20">
                        <label class="sheet-label-sm">Déclencheur :</label>
                        <textarea name="attr_declencheur" class="sheet-ruled sheet-ruled-small" rows="3"></textarea>
                    </div>
                </div>

                <!-- BLESSURES -->
                <div class="sheet-divider small mt12"><span>Blessures</span></div>
                <div class="sheet-wounds">
                    <label class="sheet-inline"><span class="sheet-windex">1.</span>
                        <input type="text" name="attr_blessure1" class="sheet-ruled-one" />
                    </label>
                    <label class="sheet-inline"><span class="sheet-windex">2.</span>
                        <input type="text" name="attr_blessure2" class="sheet-ruled-one" />
                    </label>
                    <label class="sheet-inline"><span class="sheet-windex">3.</span>
                        <input type="text" name="attr_blessure3" class="sheet-ruled-one" />
                    </label>

                    <label class="sheet-block">
                        <span class="sheet-label-sm mt8">Blessure supplémentaire :</span>
                        <textarea name="attr_blessureSuppl" class="sheet-ruled sheet-ruled-small" rows="3"></textarea>
                    </label>
                </div>
                <!-- DONS DE SCÉNARIO -->
                <div class="sheet-divider small mt12"><span>Dons de scénario</span></div>
                <label class="sheet-block mt8">
                    <span class="sheet-label-sm">Dons supplémentaire :</span>
                    <textarea name="attr_donsSuppl" class="sheet-ruled sheet-ruled-small" rows="3"></textarea>
                </label>
            </div>
        </section>

        <!-- CERCLES SOMA / XP -->
        <div class="sheet-circles">
            <button type="action" name="act_roll" class="sheet-roll-button">Jet</button>
            <!-- <button type="roll" name="roll" value="/roll d20 + ?{Bonus?|0}" >Jet</button> -->
            <div class="sheet-bigcircle">
                <div class="sheet-circle-label">Soma</div>
                <input type="number" name="attr_soma" class="sheet-circle-input">
            </div>
            <div class="sheet-bigcircle">
                <div class="sheet-circle-label">XP</div>
                <input type="number" name="attr_xp" class="sheet-circle-input">
            </div>
        </div>

    </div>



</body>

</html>